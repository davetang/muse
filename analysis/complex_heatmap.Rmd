---
title: "Making a heatmap in R with the ComplexHeatmap package"
date: "`r Sys.Date()`"
output:
  workflowr::wflow_html:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(pheatmap)
library(dendextend)
library(grid)
library(gridExtra)
```

## Installation

Install stable version from [Bioconductor](https://bioconductor.org/packages/release/bioc/html/ComplexHeatmap.html).

```{r install, eval=FALSE}
BiocManager::install("ComplexHeatmap")
```

Load library.

```{r load_complex_heatmap, message=FALSE, message=FALSE}
library(ComplexHeatmap)
```

## Data

Download example data.

```{r example_data}
example_file <- "https://davetang.org/file/TagSeqExample.tab"
data <- read.delim(example_file, header = TRUE, row.names = "gene")
data_subset <- as.matrix(data[rowSums(data)>50000,])
dim(data_subset)
```

Default heatmap for ComplexHeatmap.

```{r default_heatmap, fig.width=7, fig.height=8}
Heatmap(data_subset)
```

Normalise using z-score.

```{r default_heatmap_norm, fig.width=7, fig.height=8}
cal_z_score <- function(x){
  (x - mean(x)) / sd(x)
}

data_subset_norm <- t(apply(data_subset, 1, cal_z_score))
Heatmap(data_subset_norm)
```

Add a title using `column_title`; the `name` parameter puts a title of the heatmap legend.

```{r pheatmap_title_main, fig.width=7, fig.height=8}
Heatmap(data_subset_norm, column_title = "My title", name = "Legend")
```

Two heatmaps.

```{r two_heatmaps, fig.width=7, fig.height=8}
one <- Heatmap(data_subset, column_title = "Raw", name = "Raw")
two <- Heatmap(data_subset_norm, column_title = "Scaled", name = "Scaled")

one + two
```

Add [annotations](https://jokergoo.github.io/ComplexHeatmap-reference/book/heatmap-annotations.html).

```{r annotation, fig.height=7, fig.width=8}
set.seed(123)
mat <- matrix(rnorm(100), 10)
rownames(mat) = paste0("R", 1:10)
colnames(mat) = paste0("C", 1:10)

column_ha = HeatmapAnnotation(
  foo1 = rep(c('N', 'T'), 5),
  bar1 = anno_barplot(colMeans(mat))
)

row_ha = rowAnnotation(
  foo2 = runif(10),
  bar2 = anno_barplot(rowMeans(mat))
)

Heatmap(mat, name = "mat", top_annotation = column_ha, right_annotation = row_ha)
```

[Heatmap split](https://jokergoo.github.io/ComplexHeatmap-reference/book/a-single-heatmap.html#heatmap-split).

```{r break, fig.height=7, fig.width=8}
Heatmap(mat, name = "mat", row_km = 3, column_km = 3)
```

## UpSet plot

ComplexHeatmap has an [implementation of UpSet plots](https://jokergoo.github.io/ComplexHeatmap-reference/book/upset-plot.html).

Three lists.

```{r upset_plot_eg1}
set.seed(123)
lt <- list(a = sample(letters, 10),
          b = sample(letters, 15),
          c = sample(letters, 20))
m <- make_comb_mat(lt)
UpSet(m)
```

> union mode: 1 means in that set and 0 is not taken into account. When there are multiple 1, the relationship is OR. Then, 1 1 0 means a set of elements in set A or B, and they can also in C or not in C (union(A, B)). Under this mode, the seven combination sets can overlap.

```{r upset_plot_eg2}
m = make_comb_mat(lt, mode = "union")
UpSet(m)
```

With colours.

```{r upset_plot_eg2_col}
UpSet(m, comb_col = c(rep(2, 3), rep(3, 3), 1))
```

Compare two UpSet plots.

```{r upset_plot_eg3}
set.seed(123)
lt1 = list(a = sample(letters, 10),
          b = sample(letters, 15),
          c = sample(letters, 20))
m1 = make_comb_mat(lt1)

set.seed(456)
lt2 = list(a = sample(letters, 10),
          b = sample(letters, 15),
          c = sample(letters, 20))
m2 = make_comb_mat(lt2)

max1 = max(c(set_size(m1), set_size(m2)))
max2 = max(c(comb_size(m1), comb_size(m2)))

UpSet(m1, top_annotation = upset_top_annotation(m1, ylim = c(0, max2)),
    right_annotation = upset_right_annotation(m1, ylim = c(0, max1)),
    column_title = "UpSet1") +
UpSet(m2, top_annotation = upset_top_annotation(m2, ylim = c(0, max2)),
    right_annotation = upset_right_annotation(m2, ylim = c(0, max1)),
    column_title = "UpSet2")
```
