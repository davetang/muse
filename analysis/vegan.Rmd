---
title: "Community Ecology Package"
date: "`r Sys.Date()`"
output:
  workflowr::wflow_html:
    toc: true
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
suppressPackageStartupMessages({
  library(tidyverse)
  library(vegan)
  library(ggdendro)
})
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

The [{vegan} package](https://cran.r-project.org/web/packages/vegan/index.html) contains "Ordination methods, diversity analysis and other functions for community and vegetation ecologists."

## Setup

Install {vegan}.

```{r install_irr, eval=FALSE}
install.packages("vegan")
install.packages("ggdendro")
```

## Dissimilarity indices

`?vegdist`:

> The function computes dissimilarity indices that are useful for or popular with community ecologists. All indices use quantitative data, although they would be named by the corresponding binary index, but you can calculate the binary index using an appropriate argument. If you do not find your favourite index here, you can see if it can be implemented using designdist. Gower, Bray–Curtis, Jaccard and Kulczynski indices are good in detecting underlying ecological gradients (Faith et al. 1987). Morisita, Horn–Morisita, Binomial, Cao and Chao indices should be able to handle different sample sizes (Wolda 1981, Krebs 1999, Anderson & Millar 2004), and Mountford (1962) and Raup-Crick indices for presence–absence data should be able to handle unknown (and variable) sample sizes. Most of these indices are discussed by Krebs (1999) and Legendre & Legendre (2012), and their properties further compared by Wolda (1981) and Legendre & De Cáceres (2012). Aitchison (1986) distance is equivalent to Euclidean distance between CLR-transformed samples ("clr") and deals with positive compositional data. Robust Aitchison distance by Martino et al. (2019) uses robust CLR ("rlcr"), making it applicable to non-negative data including zeroes (unlike the standard Aitchison).

Methods include: "manhattan", "euclidean", "canberra", "clark", "bray", "kulczynski", "jaccard", "gower", "altGower", "morisita", "horn", "mountford", "raup", "binomial", "chao", "cao", "mahalanobis", "chisq", "chord", "hellinger", "aitchison", or "robust.aitchison".

Morisita index can be used with genuine count data (integers) only. Its Horn–Morisita variant is able to handle any abundance data.

The abbreviation "horn" for the Horn–Morisita index is misleading, since there is a separate Horn index. The abbreviation will be changed if that index is implemented in vegan.

`?varespec`:

* The varespec data frame has 24 rows and 44 columns.
* Columns are estimated cover values of 44 species.
* Rows are sites.
* The variable names are formed from the scientific names, and are self explanatory for anybody familiar with the vegetation type.

```{r varespec}
data(varespec)
varespec[1:6, 1:6]
```

Horn-Morisita dissimilarity indices for the first six sites.

```{r varespec_horn}
vegdist(varespec[1:6, ], method = "horn")
```

Note that:

* Diversity indices measure variation **within** a single sample.
* Similarity (and dissimilarity) indices measure how alike or different two samples are.

## Example data

Count matrix.

```{r eg1}
set.seed(1984)

cell_types <- c(
  "Neural Progenitors",
  "Neurons",
  "Astrocytes", 
  "Oligodendrocytes",
  "Microglia",
  "Endothelial",
  "Radial Glia",
  "Intermediate Progenitors"
)

count_matrix <- base::matrix(c(
  450, 480, 420, 380, 350, 340, 400, 380,
  200, 800, 150, 120, 80, 100, 250, 200,
  100, 1200, 50, 30, 20, 40, 80, 60,
  500, 300, 250, 200, 150, 100, 80, 50,
  300, 500, 200, 180, 150, 120, 200, 150
), nrow = 8, ncol = 5, byrow = FALSE)
count_matrix

base::rownames(count_matrix) <- cell_types
base::colnames(count_matrix) <- letters[1:ncol(count_matrix)]

count_matrix
```

## Similarity versus dissimilarity

* **Similarity indices** range from 0 (completely different) to 1 (identical)
* **Dissimilarity/Distance indices** range from 0 (identical) to higher values (more different)

**Conversion:** Dissimilarity = 1 - Similarity (for indices scaled 0-1)

### Bray-Curtis Dissimilarity

**What it measures:** The absolute difference in cell type abundances between two organoids, normalised by total abundance.

**Interpretation:**
* Ranges from 0 (identical) to 1 (completely different)
* 0.3-0.5 often considered moderately similar
* Sensitive to both presence/absence and abundance differences

**Key characteristic:** Most widely used in ecology; emphasises absolute differences in abundances. Does NOT account for sampling effects.

```{r bray_curtis, fig.width=10, fig.height=8}
bray_dist <- vegan::vegdist(base::t(count_matrix), method = "bray")
bray_matrix <- base::as.matrix(bray_dist)
bray_similarity <- 1 - bray_matrix
bray_similarity

pheatmap::pheatmap(
  bray_similarity,
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  display_numbers = base::round(bray_similarity, 2),
  main = "Bray-Curtis Similarity",
  color = grDevices::colorRampPalette(c("white", "yellow", "orange", "red"))(50)
)
```

### Horn-Morisita Index

**What it measures:** The probability that two randomly selected cells (one from each organoid) belong to the same cell type.

**Formula:** Based on Morisita's index but modified by Horn to be independent of sample size and species diversity.

**Interpretation:**
* Ranges from 0 (no overlap) to 1 (identical composition)
* > 0.6 typically indicates high similarity
* > 0.75 indicates very high similarity

**Key characteristic:** Robust to differences in sample size. Less affected by species richness than Bray-Curtis. Better for comparing samples with different total abundances.

```{r horn-morisita, fig.width=10, fig.height=8}
horn_dist <- vegan::vegdist(base::t(count_matrix), method = "horn")
horn_matrix <- base::as.matrix(horn_dist)
horn_similarity <- 1 - horn_matrix

pheatmap::pheatmap(
  horn_similarity,
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  display_numbers = base::round(horn_similarity, 2),
  main = "Horn-Morisita Similarity",
  color = grDevices::colorRampPalette(c("white", "yellow", "orange", "red"))(50)
)
```

### Euclidean Distance

**What it measures:** The straight-line distance between two organoids in multidimensional space (one dimension per cell type).

**Interpretation:**
* Ranges from 0 (identical) to infinity
* Larger values = more different
* No upper bound (not scaled to 1)

**Key characteristic:** Sensitive to total abundance and scale. Square root of sum of squared differences. Common in general clustering but less ideal for compositional data.

```{r euclidean, fig.width=10, fig.height=8}
euclidean_dist <- stats::dist(base::t(count_matrix), method = "euclidean")
euclidean_matrix <- base::as.matrix(euclidean_dist)

pheatmap::pheatmap(
  euclidean_matrix,
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  display_numbers = base::round(euclidean_matrix, 0),
  main = "Euclidean Distance",
  color = grDevices::colorRampPalette(c("red", "orange", "yellow", "white"))(50)
)
```
