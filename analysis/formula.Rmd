---
title: "Understanding R's Formula Syntax"
date: "`r Sys.Date()`"
output:
  workflowr::wflow_html:
    toc: true
---

```{r setup, include=FALSE}
library(tidyverse)
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction to R Formulas

R's formula syntax is a special notation that describes **relationships between variables**. It's used extensively in statistical modeling, data visualisation, and data manipulation. While it may seem cryptic at first, it's actually quite intuitive once you understand the basic components.

## Why Formulas Exist

Formulas provide a concise, readable way to specify:

- Which variable is the **response** (outcome) and which are **predictors** (explanatory variables)
- How variables interact with each other
- Complex model structures without writing lengthy function arguments

# Basic Formula Structure

The fundamental structure is:

```
response ~ predictor
```

The `~` (tilde) symbol is read as "is modeled by" or "depends on".

## Simple Examples

```{r basic-examples}
# Create sample data
set.seed(123)
df <- data.frame(
  height = rnorm(100, 170, 10),
  weight = rnorm(100, 70, 15),
  age = sample(20:60, 100, replace = TRUE),
  gender = sample(c("M", "F"), 100, replace = TRUE)
)

# Example 1: Simple linear regression
# "weight depends on height"
model1 <- lm(weight ~ height, data = df)
summary(model1)
```

# Formula Operators

## The Plus Sign (+): Adding Predictors

Use `+` to include multiple independent predictors:

```{r plus-operator}
# Multiple predictors (additive model)
# "weight depends on height AND age"
model2 <- lm(weight ~ height + age, data = df)
summary(model2)
```

## The Colon (:): Interactions

Use `:` to specify interactions between variables:

```{r colon-operator}
# Interaction term only
# "weight depends on the interaction between height and age"
model3 <- lm(weight ~ height:age, data = df)
summary(model3)
```

## The Asterisk (*): Main Effects + Interaction

Use `*` as shorthand for main effects plus their interaction:

```{r asterisk-operator}
# Main effects plus interaction
# height * age expands to: height + age + height:age
model4 <- lm(weight ~ height * age, data = df)
summary(model4)

# This is equivalent to:
model4b <- lm(weight ~ height + age + height:age, data = df)
```

## The Minus Sign (-): Removing Terms

Use `-` to exclude specific terms:

```{r minus-operator}
# Remove a term
# Include all but remove age
model5 <- lm(weight ~ height + age + gender - age, data = df)
# Equivalent to: lm(weight ~ height + gender, data = df)
```

## The Dot (.): All Other Variables

Use `.` to include all variables except the response:

```{r dot-operator}
# Use all predictors in the dataset
model6 <- lm(weight ~ ., data = df)
summary(model6)

# Remove specific variables
model7 <- lm(weight ~ . - gender, data = df)
```

## The Caret (^): Interactions Up to a Level

Use `^` to include interactions up to a specified level:

```{r caret-operator}
# All main effects and 2-way interactions
model8 <- lm(weight ~ (height + age + gender)^2, data = df)
# Expands to: height + age + gender + height:age + height:gender + age:gender

summary(model8)
```

## The Vertical Bar (|): Conditioning (Advanced)

Used in packages like `lattice` and `lme4` for grouping:

```{r eval=FALSE}
# In lattice graphics: plot y by x, separately for each level of z
xyplot(weight ~ height | gender, data = df)

# In mixed models: random effects grouped by subject
library(lme4)
lmer(weight ~ height + (1|subject), data = df)
```

# Special Functions in Formulas

## I(): Identity Function

Use `I()` to perform arithmetic operations literally:

```{r identity-function}
# Square a variable
model9 <- lm(weight ~ height + I(height^2), data = df)

# Without I(), the ^ operator has special meaning in formulas
# With I(), it's treated as arithmetic exponentiation
```

## poly(): Polynomial Terms

Create orthogonal polynomial terms:

```{r poly-function}
# Second-degree polynomial
model10 <- lm(weight ~ poly(height, 2), data = df)
summary(model10)
```

## Transformations

Apply functions directly in formulas:

```{r transformations}
# Log transformation
model11 <- lm(log(weight) ~ height, data = df)

# Multiple transformations
model12 <- lm(weight ~ log(height) + sqrt(age), data = df)
```

# Practical Examples

## Example 1: Data Visualization with Formulas

```{r visualization}
# Scatter plot with formula notation
plot(weight ~ height, data = df,
     main = "Weight vs Height",
     xlab = "Height (cm)",
     ylab = "Weight (kg)",
     pch = 19, col = "blue")
abline(lm(weight ~ height, data = df), col = "red", lwd = 2)

# Boxplot with formula
boxplot(weight ~ gender, data = df,
        main = "Weight by Gender",
        xlab = "Gender",
        ylab = "Weight (kg)",
        col = c("pink", "lightblue"))
```

## Example 2: ANOVA with Formulas

```{r anova-example}
# Create categorical data
df$age_group <- cut(df$age, breaks = c(0, 30, 45, 100),
                     labels = c("Young", "Middle", "Senior"))

# One-way ANOVA
aov1 <- aov(weight ~ age_group, data = df)
summary(aov1)

# Two-way ANOVA with interaction
aov2 <- aov(weight ~ age_group * gender, data = df)
summary(aov2)
```

## Example 3: Data Manipulation with Formulas

```{r aggregation}
# Aggregate function uses formulas
# Calculate mean weight by gender
aggregate(weight ~ gender, data = df, FUN = mean)

# Multiple variables
aggregate(cbind(weight, height) ~ gender + age_group, data = df, FUN = mean)
```

# Common Patterns and Shortcuts

## No Intercept Models

```{r no-intercept}
# Remove intercept with -1 or +0
model13 <- lm(weight ~ height - 1, data = df)
model14 <- lm(weight ~ height + 0, data = df)
```

## Update Formula

```{r update-formula}
# Update an existing model
model_updated <- update(model2, . ~ . + gender)
# Adds gender to the existing formula

# Remove a term
model_updated2 <- update(model2, . ~ . - age)
```

## Complex Interactions

```{r complex-interactions}
# Three-way interaction
model15 <- lm(weight ~ height * age * gender, data = df)

# Specific interaction structure
model16 <- lm(weight ~ height + age + height:age + gender, data = df)
```

# Formula Cheat Sheet

| Operator | Meaning | Example |
|----------|---------|---------|
| `~` | "modeled by" | `y ~ x` |
| `+` | Include term | `y ~ x + z` |
| `-` | Exclude term | `y ~ . - x` |
| `:` | Interaction only | `y ~ x:z` |
| `*` | Main effects + interaction | `y ~ x * z` equals `y ~ x + z + x:z` |
| `.` | All other variables | `y ~ .` |
| `^` | Interactions to degree | `y ~ (x + z)^2` |
| `I()` | As-is arithmetic | `y ~ I(x^2)` |
| `-1` or `+0` | Remove intercept | `y ~ x - 1` |
| `1` | Intercept only | `y ~ 1` |

# Tips for Success

1. **Start simple**: Begin with basic formulas and add complexity as needed
2. **Check expansions**: Use `model.matrix()` to see how your formula expands
3. **Name clearly**: Use descriptive variable names to make formulas readable
4. **Test interactions**: Always examine whether interactions improve your model
5. **Read the docs**: Different packages may interpret formulas slightly differently

```{r model-matrix-example}
# See how formula expands to design matrix
head(model.matrix(weight ~ height * gender, data = df))
```

# Conclusion

R's formula syntax is a powerful and elegant way to specify statistical models and data relationships. While it has a learning curve, mastering formulas will make your R code more concise and expressive. Practice with real data, and soon the notation will become second nature!

# Additional Resources

- R Documentation: `?formula`
- Model specification: `?lm`, `?glm`, `?aov`
- Formula tutorial: `vignette("formula")` in various packages
- Advanced modeling: Check packages like `lme4`, `mgcv`, and `nlme` for more complex formula applications
