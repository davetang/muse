---
title: "Is single-cell expression bimodal?"
date: "`r Sys.Date()`"
output:
  workflowr::wflow_html:
    toc: true
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
suppressPackageStartupMessages(library(Seurat))
```

# Introduction

From [MAST: a flexible statistical framework for assessing transcriptional changes and characterizing heterogeneity in single-cell RNA sequencing data](https://genomebiology.biomedcentral.com/articles/10.1186/s13059-015-0844-5):

> First, single-cell expression has repeatedly been shown to exhibit a characteristic bimodal expression pattern, wherein the expression of otherwise abundant genes is either strongly positive or undetected within individual cells.
>
> This is due in part to low starting quantities of RNA such that many genes will be below the threshold of detection, but there is also a biological component to this variation (termed extrinsic noise in the literature) that is conflated with the technical variability.
>
> We and other groups have shown that the proportion of cells with detectable expression reflects both technical factors and biological differences between samples. Results from synthetic biology also support the notion that bimodality can arise from the stochastic nature of gene expression.

# PBMC3k

Import from server.

```{r seurat_obj}
seurat_obj <- readRDS(url("https://davetang.org/file/pbmc3k_seurat.rds", "rb"))
seurat_obj
```

# Process

Use Seurat version 4.

```{r seurat_wf}
seurat_wf_v4 <- function(seurat_obj, scale_factor = 1e4, num_features = 2000, num_pcs = 30, cluster_res = 0.5, debug_flag = FALSE){
  
  seurat_obj <- NormalizeData(seurat_obj, normalization.method = "LogNormalize", scale.factor = scale_factor, verbose = debug_flag)
  seurat_obj <- FindVariableFeatures(seurat_obj, selection.method = 'vst', nfeatures = num_features, verbose = debug_flag)
  seurat_obj <- ScaleData(seurat_obj, verbose = debug_flag)
  seurat_obj <- RunPCA(seurat_obj, verbose = debug_flag)
  seurat_obj <- RunUMAP(seurat_obj, dims = 1:num_pcs, verbose = debug_flag)
  seurat_obj <- FindNeighbors(seurat_obj, dims = 1:num_pcs, verbose = debug_flag)
  seurat_obj <- FindClusters(seurat_obj, resolution = cluster_res, verbose = debug_flag)
  
  seurat_obj
}

seurat_obj <- seurat_wf_v4(seurat_obj)
seurat_obj
```

# Analysis

Most highly expressed genes in cluster 0.

```{r cluster0_cells}
wanted <- seurat_obj@meta.data$seurat_clusters == "0"
cluster0_cells <- row.names(seurat_obj@meta.data[wanted, ])
cluster0_exp <- Matrix::rowMeans(seurat_obj[, cluster0_cells]@assays$RNA$count)
cluster0_exp <- sort(cluster0_exp, decreasing = TRUE)
head(cluster0_exp, n = 9) |>
  names() -> my_genes

my_genes
```

Plot the distribution.

```{r cluster0_top_genes_dist}
Seurat::RidgePlot(seurat_obj, features = my_genes, idents = "0", layer = 'count')
```

## Detect peaks

Simple function to check how many peaks are in a distribution.

```{r is_unimodal}
is_unimodal <- function(x, bw = "SJ"){
  d <- density(x, bw = bw)
  y <- d$y
  
  peaks <- which(diff(sign(diff(y))) == -2) + 1
  length(peaks) == 1
}
```

Unimodal example.

```{r unimodal_eg}
set.seed(1984)
x1 <- rnorm(200, 0)
plot(density(x1), main = paste0("Is unimodel: ", is_unimodal(x1)))
```

Bi-modal example.

```{r unimodal_eg2}
set.seed(1984)
x2 <- c(rnorm(110, -3), rnorm(50, 3))
plot(density(x2), main = paste0("Is unimodel: ", is_unimodal(x2)))
```

## Detect peaks in gene expression

Are any of the highly expressed genes unimodal, i.e., does the simple function work?

```{r is_unimodal_highly_expressed_genes}
my_mat <- seurat_obj[names(cluster0_exp[1:200]), cluster0_cells]@assays$RNA$count
my_tests <- apply(my_mat, 1, is_unimodal)
table(my_tests)
```

Plot a unimodal example.

```{r unimodal_gene}
to_plot <- names(my_tests[my_tests == TRUE])
stopifnot(length(to_plot) > 0)
plot(density(my_mat[to_plot[1], ]), main=to_plot[1])
```

Not unimodal example.

```{r non_unimodal_gene}
to_plot <- names(my_tests[my_tests == FALSE])
stopifnot(length(to_plot) > 0)
plot(density(my_mat[to_plot[1], ]), main=to_plot[1])
```

## Check zero-inflation

Function to check for zero-inflation.

```{r check_zero_inflation}
check_zero_spike <- function(x, bw = "SJ", window = NULL, alpha = 3, min_zeros = 5) {
  x <- as.numeric(x)
  n <- length(x)
  n0 <- sum(x == 0)
  p0 <- n0 / n
 
  # no zeros
  if (n0 == 0) {
    return(list(
      n = n, zeros = 0, p_zero_obs = 0,
      window = NA_real_, expected_near_zero_prop = NA_real_,
      inflation_ratio = NA_real_, zero_inflated = FALSE, zero_is_mode = FALSE
    ))
  }
  # all zeros
  if (n0 == n) {
    return(list(
      n = n, zeros = n, p_zero_obs = 1,
      window = 0, expected_near_zero_prop = 0,
      inflation_ratio = Inf, zero_inflated = TRUE, zero_is_mode = TRUE
    ))
  }
  
  x_nz <- x[x != 0]
  
  # kernel density estimation (KDE) data has boundary bias
  # reflect if non-negative to reduce boundary bias at 0
  if (min(x_nz) >= 0) {
    x_kde <- c(x_nz, -x_nz[x_nz > 0])
  } else {
    x_kde <- x_nz
  }
  
  d <- density(x_kde, bw = bw)
  dx <- mean(diff(d$x))
  
  # choose window half-width eps
  if (is.null(window)) {
    bw_fd <- 2 * IQR(x_nz) / (length(x_nz)^(1/3))
    # basic fallback if IQR is 0 or NA
    if (!is.finite(bw_fd) || bw_fd <= 0) {
      bw_fd <- sd(x_nz) * 1.06 * length(x_nz)^(-1/5)
    }
    eps <- max(min(d$bw, bw_fd), dx)  # at least one grid step
  } else {
    eps <- as.numeric(window)
  }
  
  # smooth mass in [-eps, eps] from KDE (this integrates density over that window)
  mask <- d$x >= -eps & d$x <= eps
  p_window <- sum(d$y[mask]) * dx
  
  # expected fraction of ALL points near 0 coming from the smooth (non-zero) part
  q <- p_window * (1 - p0)
  
  # "0 is a mode?" (compare density at 0 to density at Â±eps)
  d0 <- approx(d$x, d$y, xout = 0)$y
  dr <- approx(d$x, d$y, xout = eps)$y
  dl <- approx(d$x, d$y, xout = -eps)$y
  zero_mode <- d0 >= max(c(dl, dr), na.rm = TRUE)
  
  ratio <- p0 / max(q, .Machine$double.eps)
  inflated <- (n0 >= min_zeros) && (ratio >= alpha)
  
  list(
    n = n,
    zeros = n0,
    p_zero_obs = p0,
    window = eps,
    expected_near_zero_prop = q,
    inflation_ratio = ratio,
    zero_inflated = inflated,
    zero_is_mode = zero_mode
  )
}
```

Not zero-inflated.

```{r not_zero_inflated}
set.seed(1984)
x1 <- rnorm(200, 0)
plot(density(x1), main = paste0("Is zero-inflated: ", check_zero_spike(x1)$zero_inflated))
```

Zero-inflated.

```{r zero_inflated}
set.seed(1984)
x2 <- c(rep(0, 50), rnorm(100, 2))
plot(density(x2), main = paste0("Is zero-inflated: ", check_zero_spike(x2)$zero_inflated))
```

## Detect zero-inflation in gene expression

Are any of the highly expressed genes zero-inflated, i.e., does the simple function work?

```{r is_zero_inflated_highly_expressed_genes}
my_mat <- seurat_obj[names(cluster0_exp[1:200]), cluster0_cells]@assays$RNA$count
my_tests <- apply(my_mat, 1, function(x) check_zero_spike(x)$zero_inflated)
table(my_tests)
```

Plot a zero-inflated example.

```{r zero_inflated_gene}
to_plot <- names(my_tests[my_tests == TRUE])
stopifnot(length(to_plot) > 0)
plot(density(my_mat[to_plot[1], ]), main = to_plot[1])
```

Not zero-inflated example.

```{r not_zero_inflated_gene}
to_plot <- names(my_tests[my_tests == FALSE])
stopifnot(length(to_plot) > 0)
plot(density(my_mat[to_plot[1], ]), main = to_plot[1])
```
